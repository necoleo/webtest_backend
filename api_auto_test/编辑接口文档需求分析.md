# 编辑接口文档接口需求分析

## 一、接口概述

### 1.1 接口目的
提供编辑已存在的接口文档的功能，允许用户修改文档的基本信息，如文档名称、版本号、备注等。可选择性地替换文档文件。

### 1.2 接口路径
建议：`/api/api_document/update/` 或 `/api/api_document/edit/`

### 1.3 HTTP方法
建议使用 `PUT` 或 `PATCH` 方法（考虑到Django View类的限制，实际可能使用 `POST` 方法）

## 二、数据模型分析

### 2.1 ApiDocuments模型字段

根据 `api_document_model.py`，ApiDocuments模型包含以下字段：

**可编辑字段：**
- `doc_name` (文档名称) - CharField, max_length=255
- `version` (版本号) - CharField, max_length=50
- `comment` (备注) - TextField, nullable
- 文件相关（如果支持文件替换）：
  - `cos_access_url` (COS访问URL) - URLField
  - `file_size` (文件大小) - BigIntegerField

**不可编辑字段（系统维护）：**
- `id` (主键) - AutoField
- `project_id` (所属项目id) - IntegerField - **建议不允许修改**
- `created_user` (创建人) - CharField
- `created_at` (创建时间) - DateTimeField, auto_now_add=True
- `is_parsed` (是否已解析) - BooleanField - **需要特殊处理**
- `updated_at` (更新时间) - DateTimeField, auto_now=True - **系统自动更新**

## 三、功能需求分析

### 3.1 核心功能

1. **基本信息编辑**
   - 修改文档名称 (doc_name)
   - 修改版本号 (version)
   - 修改备注信息 (comment)

2. **文件替换（可选功能）**
   - 支持上传新文件替换原有文件
   - 如果替换文件，需要：
     - 删除COS上的旧文件（或保留历史版本）
     - 上传新文件到COS
     - 更新 cos_access_url 和 file_size
     - 将 is_parsed 重置为 False（因为文件已变更）

### 3.2 业务规则

1. **文档状态校验**
   - 文档必须存在且未删除 (deleted_at IS NULL)
   - 如果文档不存在，返回错误提示

2. **已解析文档的处理策略（需确认）**
   
   **方案A：允许编辑已解析文档**
   - 仅修改基本信息（doc_name, version, comment）：保持 is_parsed 状态不变
   - 替换文件：将 is_parsed 重置为 False，需要重新解析

   **方案B：不允许编辑已解析文档**
   - 如果 is_parsed = True，返回错误提示，不允许编辑
   - 优点：避免数据不一致
   - 缺点：灵活性较差

   **建议采用方案A，但需要在业务逻辑中明确处理**

3. **版本号校验（需确认）**
   - 是否需要校验同一项目下版本号唯一性？
   - 如果允许重复版本号，则无需特殊校验
   - 如果要求唯一，需要校验同一 project_id 下是否存在相同 version（排除当前文档）

4. **项目ID修改（需确认）**
   - 建议不允许修改 project_id
   - 如果允许修改，需要考虑关联的接口数据（ApiInterfaceModel）的处理

## 四、接口设计

### 4.1 请求参数

**方案一：仅支持基本信息编辑（不包含文件替换）**

请求方式：POST
Content-Type: application/json

请求体：
```json
{
  "api_document_id": 1,          // 必填，整数
  "doc_name": "新文档名称",       // 可选，字符串，最大255字符
  "version": "1.0.1",            // 可选，字符串，最大50字符
  "comment": "更新备注信息"       // 可选，字符串
}
```

**方案二：支持文件替换（推荐）**

请求方式：POST
Content-Type: multipart/form-data 或 application/json（文件用base64编码）

请求体（multipart/form-data）：
```
api_document_id: 1               // 必填，整数
doc_name: "新文档名称"            // 可选，字符串
version: "1.0.1"                 // 可选，字符串
comment: "更新备注信息"           // 可选，字符串
file: <文件对象>                  // 可选，如果提供则替换原文件
```

### 4.2 响应格式

**成功响应（200）：**
```json
{
  "code": "000000",
  "message": "更新成功",
  "data": {
    "api_document_id": 1,
    "doc_name": "新文档名称",
    "version": "1.0.1",
    "comment": "更新备注信息",
    "cos_access_url": "https://...",  // 如果替换了文件
    "file_size": 102400,              // 如果替换了文件
    "is_parsed": false,               // 如果替换了文件，则为false
    "updated_at": "2024-01-01 12:00:00"
  }
}
```

**错误响应示例：**

文档不存在（400）：
```json
{
  "code": "400002",
  "message": "该接口文档不存在",
  "data": {}
}
```

参数无效（400）：
```json
{
  "code": "400002",
  "message": "参数无效",
  "data": {}
}
```

## 五、实现要点

### 5.1 Service层方法设计

建议在 `service.py` 中新增方法：

```python
@method_decorator(valid_params_blank(required_params_list=["api_document_id"]))
def update_api_document(self, api_document_id, doc_name=None, version=None, comment=None, file=None):
    """
    更新接口文档
    :param api_document_id: 接口文档ID（必填）
    :param doc_name: 文档名称（可选）
    :param version: 版本号（可选）
    :param comment: 备注（可选）
    :param file: 新文件（可选，如果提供则替换原文件）
    :return:
    """
```

### 5.2 实现逻辑流程

1. **参数校验**
   - 校验 api_document_id 是否存在且为整数
   - 校验可编辑字段的类型和长度限制
   - 如果提供了 file，校验文件格式和大小

2. **文档查询**
   - 根据 api_document_id 查询文档
   - 校验文档是否存在且未删除
   - 如果不存在，返回错误

3. **业务逻辑处理**
   
   **情况A：仅更新基本信息（不替换文件）**
   - 更新 doc_name（如果提供）
   - 更新 version（如果提供，可选校验唯一性）
   - 更新 comment（如果提供）
   - is_parsed 保持不变

   **情况B：替换文件**
   - 下载旧文件（可选，用于备份或删除）
   - 上传新文件到COS（参考 upload_api_document 的实现）
   - 更新 cos_access_url 和 file_size
   - 将 is_parsed 重置为 False
   - 同时更新基本信息（如果提供）

4. **数据保存**
   - 使用 update_fields 参数优化更新性能
   - 更新 updated_at 字段（自动更新）

5. **异常处理**
   - 文档不存在：ApiDocuments.DoesNotExist
   - COS上传失败：CosClientError
   - 其他异常：通用异常处理

### 5.3 View层实现

建议创建 `update_api_document_view.py`：

```python
class UpdateApiDocumentView(View):
    def __init__(self):
        self.service = Service()

    @method_decorator(valid_login_required)
    @method_decorator(require_http_methods(['POST']))
    def post(self, request):
        # 解析请求参数
        # 调用service.update_api_document
        # 返回响应
```

## 六、测试用例设计要点

### 6.1 正常流程测试

1. **仅更新基本信息**
   - 更新文档名称
   - 更新版本号
   - 更新备注
   - 组合更新多个字段

2. **替换文件**
   - 仅替换文件
   - 替换文件同时更新基本信息

3. **混合更新**
   - 部分字段更新

### 6.2 异常流程测试

1. **参数校验**
   - api_document_id 缺失
   - api_document_id 无效（非整数、负数、0）
   - doc_name 长度超限（>255字符）
   - version 长度超限（>50字符）

2. **业务校验**
   - 文档不存在
   - 文档已删除（deleted_at 不为空）
   - 版本号重复（如果要求唯一）

3. **文件相关**
   - 文件上传失败
   - 文件格式不支持
   - COS上传失败

4. **权限和认证**
   - 未登录用户
   - 登录token过期

### 6.3 边界测试

1. **字段边界**
   - doc_name 最大长度（255字符）
   - version 最大长度（50字符）
   - comment 空字符串 vs None

2. **数据状态**
   - 已解析文档（is_parsed=True）的编辑
   - 未解析文档（is_parsed=False）的编辑

## 七、注意事项

### 7.1 数据一致性

1. **文件替换后的处理**
   - 如果文档已解析（is_parsed=True）且替换了文件，需要：
     - 重置 is_parsed = False
     - 考虑是否需要删除关联的接口数据（ApiInterfaceModel）？
     - 建议：保留接口数据，用户可以选择重新解析覆盖

2. **COS文件管理**
   - 替换文件时，是否需要删除旧文件？
   - 建议：保留旧文件（作为历史版本）或删除旧文件以节省存储空间
   - 需要在业务需求中明确

### 7.2 性能考虑

1. 使用 `update_fields` 参数，只更新变更的字段
2. 文件上传使用异步处理（如果文件较大）
3. 大文件上传时考虑进度反馈

### 7.3 安全性

1. 文件类型校验（如果限制文件格式）
2. 文件大小限制
3. 防止路径遍历攻击
4. 用户权限校验（是否需要校验用户是否为文档创建人？）

## 八、待确认事项

1. **业务规则确认**
   - [ ] 是否允许编辑已解析的文档？
   - [ ] 是否允许修改 project_id？
   - [ ] 版本号是否需要唯一性校验？
   - [ ] 替换文件时，是否需要删除关联的接口数据？

2. **功能范围确认**
   - [ ] 是否支持文件替换功能？
   - [ ] 如果支持，是否需要删除COS上的旧文件？

3. **权限确认**
   - [ ] 是否需要校验用户权限（如：只能编辑自己创建的文档）？
   - [ ] 是否需要项目成员权限校验？

4. **数据保留策略**
   - [ ] COS旧文件的保留策略
   - [ ] 接口数据的处理策略（替换文件后）

## 九、参考实现

可以参考以下现有方法的实现：
- `upload_api_document`: 文件上传和COS操作
- `delete_api_document`: 文档查询和软删除
- `get_api_document`: 文档查询和字段返回

